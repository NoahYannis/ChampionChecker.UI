<!DOCTYPE html>
<html lang="de">

<head>
	<link rel="stylesheet/less" type="text/css" href="styles/styles.less" />
	<script src="https://cdn.jsdelivr.net/npm/less"></script>
	<meta charset="utf-8">
	<meta name="description" content="Endergebnis Tischtennis">
	<title>Klassenpunkte Eintragen</title>
</head>

<body>
	<header>
		<h1>Klassenpunkte</h1>
	</header>

	<main class="main-content">

		<?php
		session_start();

		require_once __DIR__ . '/MVC/Model/ClassModel.php';
		require_once __DIR__ . '/MVC/Model/Competition.php';
		require_once __DIR__ . '/MVC/Controller/IController.php';
		require_once __DIR__ . '/MVC/Controller/ClassController.php';
		require_once __DIR__ . '/MVC/Controller/CompetitionController.php';

		use MVC\Controller\CompetitionController;
		use MVC\Model\Competition;


		/**
		 * Überprüft, ob eine bestimmte Option im POST-Request ausgewählt wurde.
		 *
		 * @param string $postVar Der Name des POST-Parameters, der überprüft werden soll.
		 * @param string $option Der Wert der Option, die überprüft wird.
		 * @return string Gibt 'selected' zurück, wenn die Option ausgewählt ist, andernfalls einen leeren String.
		 */		function isOptionSelected($postVar, $option)
		{
			return isset($_POST[$postVar]) && $_POST[$postVar] == $option ? 'selected' : '';
		}


		$_SESSION['competitions'] = null; // TODO: Gecachte Wettbwerbe und Klassen korrekt anzeigen.

		if (!isset($_SESSION['competitions'])) {
			// Wettbewerbe aus der Datenbank holen, wenn noch nicht gecached
			$competitionController = new CompetitionController();
			$competitionModels = $competitionController->getAll();

			$teamCompetitions = [];
			$soloCompetitions = [];

			foreach ($competitionModels as $comp) {
				if ($comp->getIsTeam()) {
					$teamCompetitions[] = $comp;
				} else {
					$soloCompetitions[] = $comp;
				}
			}

			// Wettbewerbe cachen
			$_SESSION['competitions'] = [
				'team' => $teamCompetitions,
				'solo' => $soloCompetitions
			];
		} else {
			// Gecachte Wettbewerbe laden falls vorhanden
			/** @var Competition[] $teamCompetitions */
			$teamCompetitions = $_SESSION['competitions']['team'];

			/** @var Competition[] $soloCompetitions */
			$soloCompetitions = $_SESSION['competitions']['solo'];
		}

		$competitionSelected = !empty($_POST['competitions']);
		$selectedCompetition = null;

		// Selektierten Wettbewerb laden falls vorhanden
		if ($competitionSelected) {

			$selectedCompName = $_POST['competitions'];
			$allCompetitions = array_merge($teamCompetitions, $soloCompetitions);

			foreach ($allCompetitions as $comp) {
				if ($comp instanceof Competition && $comp->getName() === $selectedCompName) {
					$selectedCompetition = $comp;
					break; 
				}
			}

			if ($selectedCompetition) {
				$classParticipants = $selectedCompetition->getClassParticipants();
				$participantClassesNames = [];

				foreach ($classParticipants as $class) {
					$participantClassesNames[] = $class['name'];
				}
			}
		}
		?>

		<form method="POST" action="">
			<div class="styled-select">
				<!-- Wettbewerbs-Auswahl -->
				<select name="competitions" id="competitions" onchange="this.form.submit()">
					<option selected disabled value="">Wettbewerb auswählen:</option>

					<!-- Gruppe für Mannschaft -->
					<optgroup label="Mannschaft">
						<?php foreach ($teamCompetitions as $comp): ?>
							<option value="<?= htmlspecialchars($comp->getName()) ?>" <?= isOptionSelected("competitions", $comp->getName()) ?>>
								<?= htmlspecialchars($comp->getName()) ?>
							</option>
						<?php endforeach; ?>
					</optgroup>

					<!-- Gruppe für Einzeln -->
					<optgroup label="Einzel">
						<?php foreach ($soloCompetitions as $comp): ?>
							<option value="<?= htmlspecialchars($comp->getName()) ?>" <?= isOptionSelected("competitions", $comp->getName()) ?>>
								<?= htmlspecialchars($comp->getName()) ?>
							</option>
						<?php endforeach; ?>
					</optgroup>
				</select>
			</div>

			<div class="styled-select">
				<!-- Klassen-Auswahl. Nur auswählbar, wenn Wettbewerb selektiert -->
				<select name="classes" id="classes" <?= !$competitionSelected ? 'disabled' : '' ?>>
					<option value="">Klasse auswählen:</option>
					<?php foreach ($participantClassesNames as $participantClassName): ?>
						<option value="<?= htmlspecialchars($comp->getName()) ?>" <?= isOptionSelected("classes", $comp->getName()) ?>>
							<?= htmlspecialchars($participantClassName) ?>
						</option>
					<?php endforeach; ?>
				</select>
			</div>
			<input name="points" placeholder="Punktzahl eingeben:" type="number" required minlength="1" maxlength="2" />
		</form>

		<button type="submit" name="submit" value="Abschicken">Abschicken</button>

	</main>
	<footer />
	</footer>
</body>

</html>