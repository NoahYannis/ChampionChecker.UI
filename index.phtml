<!DOCTYPE html>
<html lang="de">

<head>
	<link rel="stylesheet/less" type="text/css" href="styles/styles.less" />
	<script src="https://cdn.jsdelivr.net/npm/less"></script>
	<meta charset="utf-8">
	<meta name="description" content="Endergebnis Tischtennis">
	<title>Klassenpunkte Eintragen</title>
</head>

<body>
	<header>
		<h1>Klassenpunkte</h1>
	</header>

	<main class="main-content">

		<?php
		session_start();

		require_once __DIR__ . '/MVC/Model/ClassModel.php';
		require_once __DIR__ . '/MVC/Model/Competition.php';
		require_once __DIR__ . '/MVC/Controller/IController.php';
		require_once __DIR__ . '/MVC/Controller/ClassController.php';
		require_once __DIR__ . '/MVC/Controller/CompetitionController.php';

		use MVC\Controller\CompetitionController;
		use MVC\Model\Competition;


		$_SESSION['competitions'] = null; // TODO: Gecachte Wettbwerbe und Klassen korrekt anzeigen.
		
		if (!isset($_SESSION['competitions'])) {
			// Wettbewerbe aus der Datenbank holen, wenn noch nicht gecached
			$competitionController = new CompetitionController();
			$competitionModels = $competitionController->getAll();

			$teamCompetitions = ["Mannschaft" => []];
			$soloCompetitions = ["Einzeln" => []];

			foreach ($competitionModels as $comp) {
				if ($comp->getIsTeam()) {
					$teamCompetitions["Mannschaft"][] = $comp;
				} else {
					$soloCompetitions["Einzeln"][] = $comp; 
				}
			}

			// Wettbewerbe cachen
			$_SESSION['competitions'] = [
				'team' => $teamCompetitions,
				'solo' => $soloCompetitions
			];

			var_dump($_SESSION['competitions']);
			flush();
		} 
		else 
		{
			// Gecachte Wettbewerbe laden falls vorhanden
			/** @var Competition[] $teamCompetitions */
			$teamCompetitions = $_SESSION['competitions']['team'];

			/** @var Competition[] $soloCompetitions */
			$soloCompetitions = $_SESSION['competitions']['solo'];
		}

		$competitionSelected = !empty($_POST['competitions']);
		$selectedCompetition = null;

		// Selektierten Wettbewerb laden falls vorhanden
		if ($competitionSelected) {
			$selectedCompName = $_POST['competitions'];
			foreach (['team' => $teamCompetitions, 'solo' => $soloCompetitions] as $type => $competitions) {
				foreach ($competitions as $compArray) {
					foreach ($compArray as $comp) {
						if ($comp instanceof Competition && $comp->getName() === $selectedCompName) {
							$selectedCompetition = $comp;
							break 2; // Beide Schleifen verlassen
						}
					}
				}
			}

			if ($selectedCompetition) {
				$classParticipants = $selectedCompetition->getClassParticipants();
				$participantClassesNames = [];

				foreach ($classParticipants as $class) {
					$participantClassesNames[] = $class['name'];
				}
			}
		}
		?>

		<form method="POST" action="">
			<div class="styled-select">
				<!-- Wettbewerbs-Auswahl -->
				<select name="competitions" id="competitions" onchange="this.form.submit()">
					<option value="">Wettbewerb auswählen:</option>
					<?php foreach ($teamCompetitions as $key => $competitions): ?>
						<optgroup label="<?= htmlspecialchars($key) ?>">
							<?php foreach ($competitions as $comp): ?>
								<option value="<?= htmlspecialchars($comp->getName()) ?>" <?= isset($_POST['competitions']) && $_POST['competitions'] == $comp->getName() ? 'selected' : '' ?>>
									<?= htmlspecialchars($comp->getName()) ?>
								</option>
							<?php endforeach; ?>
						</optgroup>
					<?php endforeach; ?>
					<?php foreach ($soloCompetitions as $key => $competitions): ?>
						<optgroup label="<?= htmlspecialchars($key) ?>">
							<?php foreach ($competitions as $comp): ?>
								<option value="<?= htmlspecialchars($comp->getName()) ?>" <?= isset($_POST['competitions']) && $_POST['competitions'] == $comp->getName() ? 'selected' : '' ?>>
									<?= htmlspecialchars($comp->getName()) ?>
								</option>
							<?php endforeach; ?>
						</optgroup>
					<?php endforeach; ?>
				</select>
			</div>

			<div class="styled-select">
				<!-- Klassen-Auswahl. Nur auswählbar, wenn Wettbewerb selektiert -->
				<select name="classes" id="classes" <?= !$competitionSelected ? 'disabled' : '' ?>>
					<option value="">Klasse auswählen:</option>
					<?php foreach ($participantClassesNames as $participantClassName): ?>
						<option value="<?= htmlspecialchars($participantClassName) ?>" <?= isset($_POST['classes']) && $_POST['classes'] == $participantClassName ? 'selected' : '' ?>>
							<?= htmlspecialchars($participantClassName) ?>
						</option>
					<?php endforeach; ?>
				</select>
			</div>
			<input name="points" placeholder="Punktzahl eingeben:" type="number" required minlength="1" maxlength="2" />
		</form>

		<button type="submit" name="submit" value="Abschicken">Abschicken</button>

	</main>
	<footer />
	</footer>
</body>

</html>